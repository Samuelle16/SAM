<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCF - CRM Dashboard</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

      <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
     
</head>
<body>

   

 <style>
        body {
            background-image: url("{{ url_for('static', filename='images/fond3.jpg') }}");
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
    </style>



    <!-- Navigation Bar -->
    {% if page != 'login' %}
   <div class="sidebar">
        <div class="logo">
            <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="OCF Logo">
            <span>OCF</span>
        </div>
        <ul class="menu">
        {% if session.get('role') == 'admin' %}
        <!-- Menu pour les administrateurs -->
        <li><a href="/dashboard">Tableau de Bord</a></li>
        <li><a href="/admin/all_sales">Vendeurs</a></li>
        <li><a href="/admin/sales_ranking">Classement Vendeur</a></li>
        <li><a href="/admin/view_archives">Archives</a></li>
        <li><a href="/admin/upload_sales">Mise à jour des ventes</a></li>
        <li><a href="/admin/create_user">Ajout utilisateur</a></li>
        <li><a href="/admin/set_password">renitialiser mot de passe</a></li>
        <li><a href="/logout">Logout</a></li>
        {% elif session.get('role') == 'user' %}
        <!-- Menu pour les utilisateurs -->
        <li><a href="/dashboard">Tableau de Bord</a></li>
        <li><a href="/logout">Logout</a></li>
        {% else %}
        <!-- Menu par défaut -->
        <li><a href="/login">Login</a></li>
        {% endif %}
    </ul>
    </div>
     
    <!-- Menu Icon -->
    <div class="menu-icon" id="menu-toggle">☰</div>

    {% endif %}
  


    <!-- Main Container -->
    <div class="container">


        {% if page == 'login' %}
        <div class="form-container">

           
           <audio id="background-audio" loop>
              <source src="{{ url_for('static', filename='audio/background-audio.mp3') }}" type="audio/mpeg">
              Your browser does not support the audio element.
           </audio>


          <h1 class="main-title gradient">
           Bienvenue chez OCF
            <a href="#" class="audio-toggle" title="Activer/Désactiver le son">
            <i class="fas fa-volume-up"></i>
            </a>
          </h1>

            {% if error %}
            <p class="error">{{ error }}</p>
            {% endif %}

           


            <form method="POST" action="/login">
                <input type="text" name="username" placeholder="Entrer votre nom utilisateur" required>
                <input type="password" name="password" placeholder="Entrer votre mot de passe" required>
                <button type="submit">Login</button>
            </form>
        </div>



        {% elif page == 'create_user' %}
        <h1>Créer utilisateur</h1>
        {% if error %}
        <p class="error">{{ error }}</p>
        {% endif %}
        {% if success %}
        <p class="success">{{ success }}</p>
        {% endif %}
        <form method="POST" action="/admin/create_user">
            <input type="text" name="username" placeholder="Entrer l'utilisateur" required>
            <input type="password" name="password" placeholder="Entrer le mot de passe" required>
            <button type="submit">Créer utilisateur</button>
        </form>

        {% elif page == 'upload_sales' %}
        <h1>Mettre à jour le Tableau</h1>
        {% if error %}
        <p class="error">{{ error }}</p>
        {% endif %}
        {% if success %}
        <p class="success">{{ success }}</p>
        {% endif %}
        <form method="POST" enctype="multipart/form-data" action="/admin/upload_sales">
            <input type="file" name="file" accept=".xlsx" required>
            <button type="submit">Charger</button>
        </form>


        <!-- Bouton pour exporter les utilisateurs et leurs mots de passe -->
        <form method="GET" action="/admin/export_users">
             <button type="submit">Exporter les données et mots de passe utilisateurs</button>
        </form>

        {% elif page == 'dashboard' %}
        

        <h1>Tableau de Bord</h1>
        <div class="totals-container">
            <div class="card total-vv">
                <h2>Total VV</h2>
                <p class="total-number">{{ total_vv }}</p>
                
            </div>
            <div class="card total-vr">
                <h2>Total VR</h2>
                <p class="total-number">{{ total_vr }}</p>
               
            </div>
            <div class="card total-mobiles">
                <h2>Total Mobiles</h2>
                <p class="total-number">{{ total_mobiles }}</p>
                
            </div>
        </div>


         <form method="POST" action="/dashboard" class="filter-form">
         <!-- Filtrer par nom d'utilisateur -->
         <label for="filter-username">Filtrer par Nom:</label>
         <input type="text" id="filter-username" name="filter_username" value="{{   filter_username or '' }}">

         <!-- Filtrer par numéro de contrat -->
         <label for="filter-contract-number">Filtrer par Numéro de contrat:</label>
         <input type="text" id="filter-contract-number" name="filter_contract_number"        value="{{ filter_contract_number or '' }}">

             <button type="submit">Appliquer</button>
         </form>




        <table>
            <thead>
                <tr>
                    <th>Vendeur</th>
                    <th>Catégorie</th>
                    <th>Offre</th>
                    <th>Quantité</th>
                    <th>Type</th>
                    <th>Numéro de contrat</th>
                </tr>
            </thead>
            <tbody>
                {% for sale in all_sales %}
                <tr>
                    <td>{{ sale.user.username }}</td>
                    <td>{{ sale.offer_type }}</td>
                    <td>{{ sale.plan }}</td>
                    <td>{{ sale.quantity }}</td>
                    <td>{{ sale.class_type }}</td>
                    <td>{{ sale.contract_number }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% elif page == 'all_sales' %}
       <h1>Vendeurs</h1>
<!--Ce code forme un paragraphe <p>Total Sales (All Users): {{ total_vv_sales }}</p> -->

<!-- Formulaire de filtrage -->
<form method="POST" action="/admin/all_sales" class="filter-form">
    <label for="filter-username">Filter par Nom:</label>
    <input type="text" id="filter-username" name="filter_username" value="{{ filter_username or '' }}">
    
      <!-- Filter by Numéro de Contrat -->
    <label for="filter-contract-number">Filter par Numéro de Contrat:</label>
    <input type="text" id="filter-contract-number" name="filter_contract_number" value="{{ filter_contract_number or '' }}">


    <label for="filter-role">Filtrer par role:</label>
  

    <button type="submit">Appliquer</button>
</form>

<!-- Affichage des ventes -->
{% for detail in user_sales_details %}

<div class="table-container">
<div class="user-sales">
    <h2>{{ detail.user.username }}</h2>

    <div class="totals">
        <div class="total-box">
            <h3>Total VV</h3>
            <p class="number">{{ detail.total_vv }}</p>
        </div>
        <div class="total-box">
            <h3>Total VR</h3>
            <p class="number">{{ detail.total_vr }}</p>
        </div>
        <div class="total-box">
            <h3>Total Mobiles</h3>
            <p class="number">{{ detail.total_mobiles }}</p>
        </div>
       
    </div>

    <h3>Détails des ventes :</h3>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Catégorie</th>
                <th>Offre</th>
                <th>Quantité</th>
                <th>Type</th>
                <th>Numéro de contrat</th>
            </tr>
        </thead>
        <tbody>
            {% for sale in detail.sales %}
            <tr>
                <td>{{ sale.date }}</td>
                <td>{{ sale.offer_type }}</td>
                <td>{{ sale.plan }}</td>
                <td>{{ sale.quantity }}</td>
                <td>{{ sale.class_type }}</td>
                <td>{{ sale.contract_number }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
</div>
<hr>


{% endfor %}


        {% elif page == 'sales_ranking' %}
        <h1>Classement Vendeur</h1>

         <h2 class="category-title">VR</h2>
        <table>
            <thead>
                <tr>
                    <th>Rang</th>
                    <th>Vendeur</th>
                    <th>Role</th>
                    <th>Total Quantité</th>
                </tr>
            </thead>
            <tbody>
                {% for index, user in enumerate(ranking_vr) %}
                <tr>
                    <td>{{ index + 1 }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.role }}</td>
                    <td>{{ user.total_sales }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2 class="category-title">Mobiles</h2>
        <table>
            <thead>
                <tr>
                    <th>Rang</th>
                    <th>Vendeur</th>
                    <th>Role</th>
                    <th>Total Quantité</th>
                </tr>
            </thead>
            <tbody>
                {% for index, user in enumerate(ranking_mobiles) %}
                <tr>
                    <td>{{ index + 1 }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.role }}</td>
                    <td>{{ user.total_sales }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>


        <h2 class="category-title">VV</h2>
        <table>
            <thead>
                <tr>
                    <th>Rang</th>
                    <th>Vendeur</th>
                    <th>Role</th>
                    <th>Total Quantité</th>
                </tr>
            </thead>
            <tbody>
                {% for index, user in enumerate(ranking_vv) %}
                <tr>
                    <td>{{ index + 1 }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.role }}</td>
                    <td>{{ user.total_sales }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% elif page == 'view_archives' %}

<div class="table-container">
<h1 class="page-title">Archives</h1>


{% if archives %}
<form method="POST" action="/admin/delete_archives" onsubmit="return confirm('Are you sure you want to delete all archives?');">
    <button type="submit" class="delete-button">
    Supprimer les archives</button>
</form>

<table>
    <thead>
        <tr>
            <th>Vendeur</th>
            <th>Date</th>
            <th>Catégorie</th>
            <th>Offre</th>
            <th>Quantité</th>
            <th>Numéro de contrat</th>
            <th>Archivés le</th>
        </tr>
    </thead>
    <tbody>
        {% for archive in archives %}
        <tr>
            <td>{{ archive.username }}</td>
            <td>{{ archive.date }}</td>
            <td>{{ archive.offer_type }}</td>
            <td>{{ archive.plan }}</td>
            <td>{{ archive.quantity }}</td>
            <td>{{ archive.contract_number }}</td>
            <td>{{ archive.archived_at }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>Aucun fichier archivé.</p>
        {% endif %}
        {% endif %}
    </div>


<div id="main-content">
        {% block content %}
        {% endblock %}
</div>


<script>
    document.addEventListener("DOMContentLoaded", () => {
        const tables = document.querySelectorAll("table");

        tables.forEach(table => {
            const headers = table.querySelectorAll("th");

            headers.forEach((header, index) => {
                header.addEventListener("click", () => {
                    const rows = Array.from(table.querySelectorAll("tbody > tr"));
                    const isAscending = header.classList.contains("asc");
                    const direction = isAscending ? -1 : 1;

                    rows.sort((rowA, rowB) => {
                        const cellA = rowA.children[index].innerText.trim();
                        const cellB = rowB.children[index].innerText.trim();

                        // Compare as numbers if both values are numeric
                        if (!isNaN(cellA) && !isNaN(cellB)) {
                            return direction * (parseFloat(cellA) - parseFloat(cellB));
                        }
                        // Otherwise, compare as strings
                        return direction * cellA.localeCompare(cellB);
                    });

                    // Remove old rows and append sorted rows
                    const tbody = table.querySelector("tbody");
                    tbody.innerHTML = "";
                    rows.forEach(row => tbody.appendChild(row));

                    // Update header class to reflect sort direction
                    headers.forEach(h => h.classList.remove("asc", "desc"));
                    header.classList.add(isAscending ? "desc" : "asc");
                });
            });
        });
    });
</script>

<script>
        // Script pour afficher/masquer le menu déroulant
document.addEventListener('DOMContentLoaded', () => {
    const dropdownToggle = document.querySelector('.dropdown-toggle');
    const dropdownMenu = document.querySelector('.dropdown-menu');

    dropdownToggle.addEventListener('click', () => {
        dropdownMenu.classList.toggle('show');
    });

    // Ferme le menu lorsqu'on clique ailleurs
    document.addEventListener('click', (event) => {
        if (!dropdownToggle.contains(event.target) && !dropdownMenu.contains(event.target)) {
            dropdownMenu.classList.remove('show');
        }
    });
});



 </script>

<script>
    document.querySelector('.filter-form').addEventListener('submit', e => console.log('Form Submitted!'));
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.querySelector('.sidebar');

        // Toggle sidebar when the menu icon is clicked
        menuToggle.addEventListener('click', (event) => {
            event.stopPropagation(); // Empêche la propagation pour que le clic sur le bouton ne ferme pas le menu
            sidebar.classList.toggle('active');
        });

        // Close sidebar when clicking outside of it
        document.addEventListener('click', (event) => {
            if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                sidebar.classList.remove('active');
            }
        });
    });
</script>


<script>
    document.addEventListener("DOMContentLoaded", () => {
        const audioElement = document.querySelector("audio");
        const audioToggle = document.querySelector(".audio-toggle");
        const audioIcon = audioToggle.querySelector("i");

        audioToggle.addEventListener("click", (event) => {
            event.preventDefault();

            if (audioElement.paused) {
                audioElement.play();
                audioIcon.classList.remove("fa-volume-mute");
                audioIcon.classList.add("fa-volume-up");
            } else {
                audioElement.pause();
                audioIcon.classList.remove("fa-volume-up");
                audioIcon.classList.add("fa-volume-mute");
            }
        });
    });
</script>





</body>
</html>