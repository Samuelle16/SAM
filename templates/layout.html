<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCF - CRM Dashboard</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="logo">
            <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="OCF Logo">
            <span>OCF</span>
        </div>
        
        <div class="dropdown">
            <button class="dropdown-toggle">Menu</button>
            <ul class="dropdown-menu">
                {% if session.get('role') == 'admin' %}
                <li><a href="/dashboard">Dashboard</a></li>
                <li><a href="/admin/create_user">Add User</a></li>
                <li><a href="/admin/upload_sales">Upload Sales</a></li>
                <li><a href="/admin/all_sales">All Users & Sales</a></li>
                <li><a href="/admin/sales_ranking">Sales Ranking</a></li>
                <li><a href="/admin/view_archives">Archived Sales</a></li>
                <li><a href="/admin/set_password">Set Password</a></li>
                <li><a href="/logout">Logout</a></li>
                {% elif session.get('role') == 'user' %}
                <li><a href="/dashboard">Dashboard</a></li>
                <li><a href="/logout">Logout</a></li>
                {% else %}
                <li><a href="/login">Login</a></li>
                {% endif %}
            </ul>
        </div>
    </nav>


    <!-- Main Container -->
    <div class="container">
        {% if page == 'login' %}
        <div class="form-container">
            <h1 class="main-title gradient">Welcome to OCF</h1>
            {% if error %}
            <p class="error">{{ error }}</p>
            {% endif %}
            <form method="POST" action="/login">
                <input type="text" name="username" placeholder="Enter your username" required>
                <input type="password" name="password" placeholder="Enter your password" required>
                <button type="submit">Login</button>
            </form>
        </div>

        {% elif page == 'create_user' %}
        <h1>Create a New User</h1>
        {% if error %}
        <p class="error">{{ error }}</p>
        {% endif %}
        {% if success %}
        <p class="success">{{ success }}</p>
        {% endif %}
        <form method="POST" action="/admin/create_user">
            <input type="text" name="username" placeholder="Enter username" required>
            <input type="password" name="password" placeholder="Enter password" required>
            <button type="submit">Create User</button>
        </form>

        {% elif page == 'upload_sales' %}
        <h1>Upload Sales</h1>
        {% if error %}
        <p class="error">{{ error }}</p>
        {% endif %}
        {% if success %}
        <p class="success">{{ success }}</p>
        {% endif %}
        <form method="POST" enctype="multipart/form-data" action="/admin/upload_sales">
            <input type="file" name="file" accept=".xlsx" required>
            <button type="submit">Upload</button>
        </form>

        {% elif page == 'dashboard' %}
        <h1>Dashboard</h1>
        <div class="totals-container">
            <div class="card total-vv">
                <h2>Total VV Sales</h2>
                <p class="total-number">{{ total_vv }}</p>
                <p>VV sales generated so far</p>
            </div>
            <div class="card total-vr">
                <h2>Total VR Sales</h2>
                <p class="total-number">{{ total_vr }}</p>
                <p>VR sales generated so far</p>
            </div>
            <div class="card total-mobiles">
                <h2>Total Mobile Sales</h2>
                <p class="total-number">{{ total_mobiles }}</p>
                <p>Mobile sales generated so far</p>
            </div>
        </div>
        <h2>Sales</h2>
        <table>
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Offer Type</th>
                    <th>Plan</th>
                    <th>Quantité</th>
                    <th>Class</th>
                    <th>Numéro de contrat</th>
                </tr>
            </thead>
            <tbody>
                {% for sale in all_sales %}
                <tr>
                    <td>{{ sale.user.username }}</td>
                    <td>{{ sale.offer_type }}</td>
                    <td>{{ sale.plan }}</td>
                    <td>{{ sale.quantity }}</td>
                    <td>{{ sale.class_type }}</td>
                    <td>{{ sale.contract_number }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% elif page == 'all_sales' %}
       <h1>All Users and Sales</h1>
<p>Total Sales (All Users): {{ total_global_sales }}</p>

<!-- Formulaire de filtrage -->
<form method="POST" action="/admin/all_sales" class="filter-form">
    <label for="filter-username">Filter by Username:</label>
    <input type="text" id="filter-username" name="filter_username" value="{{ filter_username or '' }}">
    
    <label for="filter-role">Filter by Role:</label>
    <select id="filter-role" name="filter_role">
        <option value="">-- Select Role --</option>
        <option value="user" {% if filter_role == 'user' %}selected{% endif %}>User</option>
        <option value="manager" {% if filter_role == 'manager' %}selected{% endif %}>Manager</option>
    </select>

    <button type="submit">Apply Filters</button>
</form>

<!-- Affichage des ventes -->
{% for detail in user_sales_details %}
<div class="user-sales">
    <h2>{{ detail.user.username }}</h2>
    <p>Role: {{ detail.user.role }}</p>

    <div class="totals">
        <div class="total-box">
            <h3>Total VV</h3>
            <p class="number">{{ detail.total_vv }}</p>
        </div>
        <div class="total-box">
            <h3>Total VR</h3>
            <p class="number">{{ detail.total_vr }}</p>
        </div>
        <div class="total-box">
            <h3>Total Mobiles</h3>
            <p class="number">{{ detail.total_mobiles }}</p>
        </div>
        <div class="total-box total-sales">
            <h3>Total Sales</h3>
            <p class="number">{{ detail.total_vv + detail.total_vr + detail.total_mobiles }}</p>
        </div>
    </div>

    <h3>Détails des ventes :</h3>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Type d'offre</th>
                <th>Plan</th>
                <th>Quantité</th>
                <th>Classe</th>
                <th>Numéro de contrat</th>
            </tr>
        </thead>
        <tbody>
            {% for sale in detail.sales %}
            <tr>
                <td>{{ sale.date }}</td>
                <td>{{ sale.offer_type }}</td>
                <td>{{ sale.plan }}</td>
                <td>{{ sale.quantity }}</td>
                <td>{{ sale.class_type }}</td>
                <td>{{ sale.contract_number }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<hr>


{% endfor %}


        {% elif page == 'sales_ranking' %}
        <h1>Sales Ranking</h1>
        <h2>Mobiles</h2>
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Total Quantité</th>
                </tr>
            </thead>
            <tbody>
                {% for index, user in enumerate(ranking_mobiles) %}
                <tr>
                    <td>{{ index + 1 }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.role }}</td>
                    <td>{{ user.total_sales }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2>VR</h2>
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Total Quantité</th>
                </tr>
            </thead>
            <tbody>
                {% for index, user in enumerate(ranking_vr) %}
                <tr>
                    <td>{{ index + 1 }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.role }}</td>
                    <td>{{ user.total_sales }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2>VV</h2>
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Total Quantité</th>
                </tr>
            </thead>
            <tbody>
                {% for index, user in enumerate(ranking_vv) %}
                <tr>
                    <td>{{ index + 1 }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.role }}</td>
                    <td>{{ user.total_sales }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% elif page == 'view_archives' %}
        <h1>Archived Sales</h1>
        {% if archives %}
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Offer Type</th>
                    <th>Plan</th>
                    <th>Quantité</th>
                    <th>Numéro de contrat</th>
                    <th>Archived At</th>
                </tr>
            </thead>
            <tbody>
                {% for archive in archives %}
                <tr>
                    <td>{{ archive.date }}</td>
                    <td>{{ archive.offer_type }}</td>
                    <td>{{ archive.plan }}</td>
                    <td>{{ archive.quantity }}</td>
                    <td>{{ archive.contract_number }}</td>
                    <td>{{ archive.archived_at }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No archived sales available.</p>
        {% endif %}
        {% endif %}
    </div>


<script>
    document.addEventListener("DOMContentLoaded", () => {
        const tables = document.querySelectorAll("table");

        tables.forEach(table => {
            const headers = table.querySelectorAll("th");

            headers.forEach((header, index) => {
                header.addEventListener("click", () => {
                    const rows = Array.from(table.querySelectorAll("tbody > tr"));
                    const isAscending = header.classList.contains("asc");
                    const direction = isAscending ? -1 : 1;

                    rows.sort((rowA, rowB) => {
                        const cellA = rowA.children[index].innerText.trim();
                        const cellB = rowB.children[index].innerText.trim();

                        // Compare as numbers if both values are numeric
                        if (!isNaN(cellA) && !isNaN(cellB)) {
                            return direction * (parseFloat(cellA) - parseFloat(cellB));
                        }
                        // Otherwise, compare as strings
                        return direction * cellA.localeCompare(cellB);
                    });

                    // Remove old rows and append sorted rows
                    const tbody = table.querySelector("tbody");
                    tbody.innerHTML = "";
                    rows.forEach(row => tbody.appendChild(row));

                    // Update header class to reflect sort direction
                    headers.forEach(h => h.classList.remove("asc", "desc"));
                    header.classList.add(isAscending ? "desc" : "asc");
                });
            });
        });
    });
</script>

<script>
        // Script pour afficher/masquer le menu déroulant
        const dropdownToggle = document.querySelector('.dropdown-toggle');
        const dropdownMenu = document.querySelector('.dropdown-menu');

        dropdownToggle.addEventListener('click', () => {
            dropdownMenu.classList.toggle('show');
        });

        // Fermer le menu si on clique ailleurs
        document.addEventListener('click', (event) => {
            if (!dropdownToggle.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.remove('show');
            }
        });

 </script>

 <script>

const dropdownToggle = document.querySelector('.dropdown-toggle');
const dropdownMenu = document.querySelector('.dropdown-menu');

dropdownToggle.addEventListener('click', () => {
    dropdownMenu.classList.toggle('show'); // Affiche ou masque le menu

    // Récupère les dimensions du menu et de la fenêtre
    const menuRect = dropdownMenu.getBoundingClientRect();
    const viewportWidth = window.innerWidth;

    if (menuRect.right > viewportWidth) {
        // Si le menu dépasse à droite, réaligne-le à gauche
        dropdownMenu.style.left = 'auto';
        dropdownMenu.style.right = '10px';
    } else if (menuRect.left < 0) {
        // Si le menu dépasse à gauche, réaligne-le à droite
        dropdownMenu.style.left = '10px';
        dropdownMenu.style.right = 'auto';
    } else {
        // Sinon, centre-le par rapport au bouton
        dropdownMenu.style.left = '50%';
        dropdownMenu.style.right = 'auto';
        dropdownMenu.style.transform = 'translateX(-50%)';
    }
});


 </script>

</body>
</html>
